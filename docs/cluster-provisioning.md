# Cluster Provisioning

## Overview
The ORAN O2IMS Operator serves as an O-Cloud Manager, orchestrating the complete lifecycle of cluster provisioning via the `ProvisioningRequest` CR, starting from hardware provisioning and cluster installation to cluster configuration.

The operator leverages several key components to achieve this:
- [ORAN Hardware Manager Plugin](https://github.com/openshift-kni/oran-hwmgr-plugin/tree/main): Manages `NodePool` CR, interacting with the hardware manager to provision and allocate nodes for the cluster.
- [SiteConfig Operator](https://github.com/stolostron/siteconfig): Manages the `ClusterInstance` CR, initiating the cluster installation process.
- [ACM Policy Engine](https://github.com/open-cluster-management-io/governance-policy-propagator): Enforces configuration `Policies` to ensure the installed cluster is properly configured and compliant with operational requirements.

## Preparation

### Prerequisites on Hub Cluster

Ensure the following operators are installed on the hub cluster:
- Advanced Cluster Management (ACM)
- Red Hat OpenShift GitOps Operator
- SiteConfig Operator
- ORAN Hardware Manager Plugin

### Git Respository Setup

Prepare a Git repository containing all necessary files for cluster provisioning and configuration, and sync it with ArgoCD. Follow the recommended directory structure as documented [here](samples/git-setup/).

## ClusterTemplate CR

A namespace-scoped CR managed by the O-Cloud Manager, defining the resources and parameters required for cluster provisioning. An example of ClusterTemplate can be found [here](../config/samples/v1alpha1_clustertemplate.yaml).

The [CRD](../config/crd/bases/o2ims.provisioning.oran.org_clustertemplates.yaml)'s `spec` fields include:
- name: Specifies the base name of the ClusterTemplate.
- version: Defines the version of the ClusterTemplate.
- description: A description of the ClusterTemplate.
- templates:
    - hwTemplate: References the ConfigMap containing the hardware template used for node allocation.
    - clusterInstanceDefaults: References the ConfigMap containing default values for ClusterInstance.
    - policyTemplateDefaults: References the ConfigMap containing default values for ACM policy templates.
- templateParameterSchema: Specifies the OpenAPI v3 schema that defines the accepted and required parameters for provisioning a cluster. This schema is used to validate the parameters passed in the ProvisioningRequest.
- templateId: A unique identifier (UUID) for the ClusterTemplate, automatically generated by the O-Cloud Manager if not provided.
- characteristics(FFS): A list of key-value pairs describing characteristics associated with the template.

The name of the ClusterTemplate CR must follow the format `<name.version>`, and **it must be unique across all namespaces**. The combination of name and version uniquely defines a template.

The schema defined in the `templateParameterSchema` must include the following **mandatory** parameters for the cluster provisioning process:
 - nodeClusterName: Specifies the name of the node cluster.
 - oCloudSiteId: Specifies the oCloud site identifier.
 - policyTemplateParameters: A subschema that defines the parameters for cluster configuration.
 - clusterInstanceParameters: A subschema for ClusterInstance, defining the parameters that are allowed in the ProvisioningRequest for cluster installation.

When a ClusterTemplate is created, O-Cloud Manager validates the following to ensure:
- The name is unique across all namespaces.
- All referenced ConfigMaps exist.
- The required paramaters are present in the schema.

Once validation is successful, the status condition `ClusterTemplateValidated` will be set to `True`. After validation, any changes to `spec` are disallowed and will be rejected. The referenced configmaps are also immutable after validation.

```console
status:
  conditions:
  - lastTransitionTime: "2024-10-19T00:00:06Z"
    message: The cluster template validation succeeded
    reason: Completed
    status: "True"
    type: ClusterTemplateValidated
```

## ProvisioningRequest CR

A cluster-scoped CR managed by the O-Cloud Manager, providing all neccessary parameters for provisioning a cluster. An example of ProvisioningRequest can be found [here](../config/samples/v1alpha1_provisioningrequest.yaml).

The [CRD](../config/crd/bases/o2ims.provisioning.oran.org_provisioningrequests.yaml)'s `spec` fields include:
- name: Defines a human-readable name for the Provisioning Request.
- description: A brief description of the Provisioning Request.
- templateName: Specifies the base name of the referenced ClusterTemplate.
- templateVersion: Specifies the version of the referenced ClusterTemplate.
- templateParameters: Provides the input data that conforms to the OpenAPI v3 schema defined in the referenced ClusterTemplate.
- extensions(FFS): A set of key-value pairs extending the cluster's configuration.

The status of the provisioning process is tracked via the following `status.conditions`:
- ProvisioningRequestValidated: The ProvisioningRequest has been validated.
- ClusterInstanceRendered: The ClusterInstance has been successfully rendered and validated.
- ClusterResourcesCreated: The necessary cluster resources have been created.
- HardwareTemplateRendered: The hardware template has been successfully rendered.
- HardwareProvisioned: Hardware provisioning is complete.
- ClusterProvisioned: Cluster installation is complete.
- ConfigurationApplied: Configuration has been successfully applied via ACM enforce policies.

The `status.provisioningStatus` tracks the overall provisioning state.
- progressing: When any part of provisioning process begins (hardware provisioning, cluster installation, or cluster configuration).
- fulfilled: When all stages of provisioning process are successfully completed.
- failed: If any stage of provisioning process fails or times out, including resources validation or preparation.

## Provisioning process walkthrough

The O-Cloud Manager orchestrates the cluster provisioning process, which is initiated by creating a `ProvisioningRequest` CR. Below is the general flow of the provisioning process:

**The general success workflow**:
ProvisioningRequestValidated -> ClusterInstanceRendered -> ClusterResourcesCreated -> HardwareTemplateRendered -> HardwareProvisioned -> ClusterProvisioned -> ConfigurationApplied

**Steps are**:

1. O-Cloud Manager first validates the ProvisioningRequest CR, including but not limited to:
    - Verify timeout values for hardware provisioning, cluster installation, or configuration as specified in the respective ConfigMaps if provided.
    - Validate the `clusterInstanceParameters` against the subschema defined in the ClusterTemplate. Any fields not present in the subschema but provided in the `clusterInstanceParameters` are disallowed and will cause validation failure.
    - Validate the merged policy template input data (`policyTemplateParameters` combined with default values in the `policyTemplateDefaults` ConfigMap) against the PolicyTemplate subschema.
2. Render the ClusterInstance CR with the merged ClusterInstance input (data from `clusterInstanceParameters` combined with the default values in the `clusterInstanceDefaults` ConfigMap) and validate it via client dry-run.
3. Prepare the neccessary resources for provisioning.
    - Copy the extra-manifests ConfigMap from the ClusterTemplate namespace to the cluster namespace
    - Copy the pull-secret from the ClusterTemplate namespace to the cluster namespace
    - Create the ConfigMap for templated ACM policies in the ClusterTemplate namespace 
4. Render the NodePool CR based on the provided hardware template in the `hwTemplate` ConfigMap.

   Example status:

    ```console
    status:
      conditions:
      - lastTransitionTime: "2024-10-19T00:27:08Z"
        message: The provisioning request validation succeeded
        reason: Completed
        status: "True"
        type: ProvisioningRequestValidated
      - lastTransitionTime: "2024-10-19T00:27:09Z"
        message: ClusterInstance rendered and passed dry-run validation
        reason: Completed
        status: "True"
        type: ClusterInstanceRendered
      - lastTransitionTime: "2024-10-19T00:27:09Z"
        message: Cluster resources applied
        reason: Completed
        status: "True"
        type: ClusterResourcesCreated
      - lastTransitionTime: "2024-10-19T00:27:09Z"
        message: Rendered Hardware template successfully
        reason: Completed
        status: "True"
        type: HardwareTemplateRendered
    ```
5. Create NodePool CR to start hardware provisioning. The corresponding hardware manager plugin consumes the CR and communicates with the hardware manager to allocate resources.

    Example status:

    ```console
    status:
      conditions:
      ...
      - lastTransitionTime: "2024-10-19T00:27:30Z"
        message: Handling creation
        reason: InProgress
        status: "False"
        type: HardwareProvisioned
      provisioningStatus:
        provisioningDetails: Hardware provisioning is in progress
        provisioningState: progressing
    ```

6. Wait for hardware provisioning to complete. Once it completes, the plugin sends the allocated node infomation (BMC secret, BMC url, interface MAC addresses, etc.) in the NodePool status. O-Cloud Manager retrieves this data and updates the rendered ClusterInstance CR with it.
7. Create the rendered ClusterInstance to kick off cluster installation. The SiteConfig operator consumes the CR and starts the installation.

    Example status:

    ```console
    status:
      clusterDetails:
        clusterProvisionStartedAt: "2024-10-19T00:27:31Z"
        name: sno1
        ztpStatus: ZTP Not Done
      conditions:
      ...
      - lastTransitionTime: "2024-10-19T00:27:30Z"
        message: Created
        reason: Completed
        status: "True"
        type: HardwareProvisioned
      - lastTransitionTime: "2024-10-19T00:27:31Z"
        message: Applied and processed ClusterInstance (sno1) successfully
        reason: Completed
        status: "True"
        type: ClusterInstanceProcessed
      - lastTransitionTime: "2024-10-20T00:28:00Z"
        message: Provisioning cluster
        reason: InProgress
        status: "False"
        type: ClusterProvisioned
      - lastTransitionTime: "2024-10-19T00:28:15Z"
        message: The Cluster is not yet ready
        reason: ClusterNotReady
        status: "False"
        type: ConfigurationApplied
      provisioningStatus:
        provisioningDetails: Cluster installation is in progress
        provisioningState: progressing
    ```
8. Wait for cluster installation to complete and for the ManagedCluster to become Ready. ACM reconciles the enforce policies and applies the configuration.

    Example status:

    ```console
    status:
      clusterDetails:
        clusterProvisionStartedAt: "2024-10-19T00:27:31Z"
        name: sno1
        ztpStatus: ZTP Not Done
      conditions:
      ...
      - lastTransitionTime: "2024-10-19T00:27:30Z"
        message: Created
        reason: Completed
        status: "True"
        type: HardwareProvisioned
      - lastTransitionTime: "2024-10-19T00:27:31Z"
        message: Applied and processed ClusterInstance (sno1) successfully
        reason: Completed
        status: "True"
        type: ClusterInstanceProcessed
      - lastTransitionTime: "2024-10-20T00:56:16Z"
        message: Provisioning completed
        reason: Completed
        status: "True"
        type: ClusterProvisioned
      - lastTransitionTime: "2024-10-19T00:56:30Z"
        message: The configuration is still being applied
        reason: InProgress
        status: "False"
        type: ConfigurationApplied
      provisioningStatus:
        provisioningDetails: Cluster configuration is being applied
        provisioningState: progressing
    ```
9. After all policies are compliant, set `provisioningStatus.provisioningState` to fulfilled and `clusterDetails.ztpStatus` to ZTP Done, indicating successful provisioning.

   Example status:

    ```console
    status:
      clusterDetails:
        clusterProvisionStartedAt: "2024-10-19T00:27:31Z"
        name: sno1
        ztpStatus: ZTP Done
      conditions:
      ...
      - lastTransitionTime: "2024-10-19T00:27:30Z"
        message: Created
        reason: Completed
        status: "True"
        type: HardwareProvisioned
      - lastTransitionTime: "2024-10-19T00:27:31Z"
        message: Applied and processed ClusterInstance (sno1) successfully
        reason: Completed
        status: "True"
        type: ClusterInstanceProcessed
      - lastTransitionTime: "2024-10-20T00:56:16Z"
        message: Provisioning completed
        reason: Completed
        status: "True"
        type: ClusterProvisioned
      - lastTransitionTime: "2024-10-19T01:20:33Z"
        message: The configuration is up to date
        reason: Completed
        status: "True"
        type: ConfigurationApplied
      provisioningStatus:
        provisioningDetails: Provisioning request has completed successfully
        provisioningState: fulfilled
    ```

## Immutable ClusterInstance ##
Once cluster installation has started (indicated by the `ClusterProvisioned` condition being InProgress), only the `extraLabels` and `extraAnnotations` fields can be modified in the ProvisioningRequest. Any changes to other immutable fields will cause the `ClusterInstanceRendered` condition to fail.

## Timeout configuration ##
Each stage of the cluster provisioning process has a default timeout. If an operation does not complete within the allowed time, the provisioning process is considered failed, and the relevant status conditions and overall provisioning status will be updated to reflect the timeout.

Default timeouts:
- Hardware provisioning: 90m
- Cluster installation: 90m
- Cluster configuration 30m

These timeouts can be configured in their respective ConfigMaps. The timeout value should be a duration string. For example:

For hardware provisioning, set in the `spec.templates.hwTemplate` ConfigMap:
``` yaml
data:
  hardwareProvisioningTimeout: "100m"
```

For cluster installation, set in the `spec.templates.clusterInstanceDefaults` ConfigMap:
``` yaml
data:
  clusterInstallationTimeout: "100m"
```

For cluster configuration, set in the `spec.templates.policyTemplateDefaults` ConfigMap:
``` yaml
data:
  clusterConfigurationTimeout: "40m"
```

## Monitoring Process
To watch the O-Cloud Manager controller logs:
```console
oc logs -n oran-o2ims -l control-plane=controller-manager -f
```
